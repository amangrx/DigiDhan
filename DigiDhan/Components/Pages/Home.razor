@page "/home"

<h1>Digi Dhan</h1>
<p> Total Transaction: @totalNumberTransaction</p>
<p> Current Balance: @currentBalance</p>
<div class="cards-container">
    <div class="card">
        <h2>Income</h2>
        <p>Highest: @highestIncome</p>
        <p>Lowest: @lowestIncome</p>
        <hr />
        <p>Total:@totalIncome</p>
    </div>
    <div class="card">
        <h2>Expense</h2>
        <p>Highest: @highestExpense</p>
        <p>Lowest: @lowestExpense</p>
        <hr />
        <p>Total:@totalExpense </p>
    </div>
    <div class="card">
        <h2>Debt</h2>
        <p>Highest: @highestDebt</p>
        <p>Lowest: @lowestDebt</p>
        <hr />
        <p>Remaining Debt:@totalPendingDebt </p>
        <p>Cleared Debt @totalClearedDebt</p>
        <p>Total: @totalDebt</p>
    </div>
</div>

<button class="submit-btn" @onclick="SortByDate" type="submit">Sort Date</button>
<p>@searchByDateFrom</p>
<p>@searchByDateTo</p>
<!--For specifying transactions of certain date-->
<div>
    <label>From: </label>
    <input type="date" @bind="searchByDateFrom" />
</div>
<div>
    <label>To: </label>
    <input type="date" @bind="searchByDateTo" />
</div>
<button class="submit-btn" @onclick="SpecifyByDate" type="submit">Search</button>

<style>
    .cards-container {
        display: flex;
        gap: 20px;
        margin: 20px 0;
    }

    .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        width: 200px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
</style>

<table>
    <thead>
        <tr>
            <th>Category</th>
            <th>Amount</th>
            <th>Source</th>
            <th>Date</th>
            <th>Tags</th>
            <th>Note</th>
            <th>Type</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var transaction in transaction)
        {
            <tr>
                <td>@transaction.category</td>
                <td>@transaction.amount</td>
                <td>@transaction.source</td>
                <td>@transaction.dateOfTransaction</td>
                <td>@transaction.tags</td>
                <td>@transaction.note</td>
                <td>
                    @if (transaction.category == "Income")
                    {
                        @transaction.incomeType
                    }
                    else if (transaction.category == "Expense")
                    {
                        @transaction.expenseType
                    }
                    else
                    {
                        @if (transaction.debtType == DebtType.Pending)
                        {
                            <span style="background-color: red; color: white; padding: 5px;">@transaction.debtType.ToString()</span>
                        }
                        else
                        {
                            <span style="background-color: darkgreen; color: white; padding: 5px;">@transaction.debtType.ToString()</span>
                        }
                    }
                </td>
            </tr>
        }
    </tbody>
</table>


@code {
    private List<Transaction> transaction = new List<Transaction>();
    private DatabaseExtraction databaseExtraction = new DatabaseExtraction();
    private int currentBalance = 0;
    private int highestIncome = 0;
    private int lowestIncome = 0;
    private int highestExpense = 0;
    private int lowestExpense = 0;
    private int highestDebt = 0;
    private int lowestDebt = 0;
    private int totalNumberTransaction;

    private int totalIncome = 0;
    private int totalExpense = 0;
    private int totalDebt = 0;

    private int totalPendingDebt = 0;
    private int totalClearedDebt = 0;

    // variable for dashboard filtering by specific date range.
    private DateOnly searchByDateFrom;
    private DateOnly searchByDateTo;

    public void SortByDate()
    {
        transaction = databaseExtraction.SortByDate();
    }

    public void SpecifyByDate()
    {
        transaction = databaseExtraction.SearchBySpecificDateRange(searchByDateFrom, searchByDateTo);
    }

    protected override async Task OnInitializedAsync()
    {
        transaction = databaseExtraction.GetTransactions();
        totalNumberTransaction = databaseExtraction.GetNumberTransaction();
        currentBalance = databaseExtraction.GetUserBalance(1);
        FetchHighestAndLowestValues();
        FetchTotal();
    }

    private void FetchHighestAndLowestValues()
    {
        highestIncome = databaseExtraction.GetHighest("incomes");
        lowestIncome = databaseExtraction.GetLowest("incomes");

        highestExpense = databaseExtraction.GetHighest("expenses");
        lowestExpense = databaseExtraction.GetLowest("expenses");

        highestDebt = databaseExtraction.GetHighest("debt");
        lowestDebt = databaseExtraction.GetLowest("debt");
    }

    private void FetchTotal()
    {
        totalIncome = databaseExtraction.GetTotal("incomes");
        totalExpense = databaseExtraction.GetTotal("expenses");
        totalDebt = databaseExtraction.GetTotal("debt");
        totalPendingDebt = databaseExtraction.GetPendingAndClearedTotal("Pending");
        totalClearedDebt = databaseExtraction.GetPendingAndClearedTotal("Cleared");
    }

}
